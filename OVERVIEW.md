# 项目概览：Stripe自动余额管理系统

## 🎯 项目目标
创建一个智能的余额管理系统，当用户余额低于设定阈值时自动充值到目标金额，用户承担手续费。

## 💡 核心价值
- **自动化管理** - 无需手动监控余额，系统自动处理
- **安全可靠** - 基于Stripe官方API，银行级安全标准
- **用户友好** - 现代化界面，支持多种支付方式
- **完全透明** - 详细的费用计算和交易记录

## 🏗️ 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端界面      │    │   后端API      │    │   Stripe API    │
│                 │    │                 │    │                 │
│ - 支付方式设置  │◄──►│ - 余额监控      │◄──►│ - 支付处理      │
│ - 配置管理      │    │ - 自动充值      │    │ - 客户管理      │
│ - 状态显示      │    │ - 定时任务      │    │ - 安全存储      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
           │                       │                       │
           └───────────────────────┼───────────────────────┘
                                   │
                         ┌─────────▼─────────┐
                         │   PostgreSQL     │
                         │                  │
                         │ - 用户数据       │
                         │ - 配置信息       │
                         │ - 交易记录       │
                         └──────────────────┘
```

## 📊 核心功能流程

### 1. 用户设置
```
用户访问 → 配置阈值 → 添加支付方式 → 启用自动充值
```

### 2. 余额监控
```
定时检查(5分钟) → 获取当前余额 → 判断是否低于阈值 → 触发充值流程
```

### 3. 自动充值
```
计算充值金额 → 计算手续费 → 创建支付意图 → 执行支付 → 更新余额 → 记录交易
```

## 🔢 费用计算示例

假设用户设置：
- **最小余额**: $150
- **目标余额**: $600
- **当前余额**: -$50

计算过程：
1. **需要充值**: $600 - (-$50) = $650
2. **手续费**: $650 × 2.9% = $18.85
3. **总扣费**: $650 + $18.85 = $668.85
4. **充值后余额**: $600

## 🛠️ 技术栈选择

### 后端
- **Node.js + TypeScript** - 类型安全的JavaScript运行时
- **Express.js** - 简洁的Web框架
- **Prisma ORM** - 现代化数据库访问层
- **PostgreSQL** - 可靠的关系型数据库

### 前端
- **Vanilla JavaScript** - 原生JS，无框架依赖
- **Stripe Elements** - 官方支付组件
- **CSS3** - 现代化响应式设计

### 部署
- **Railway** - 现代化云平台
- **Docker** - 容器化部署
- **GitHub Actions** - 自动化CI/CD

## 📈 关键指标

### 性能指标
- **响应时间**: < 500ms (API请求)
- **可用性**: 99.9% (目标)
- **充值成功率**: > 95%

### 业务指标
- **平均充值金额**: 待统计
- **用户活跃度**: 待统计
- **手续费收入**: 透明显示

## 🔐 安全措施

### 数据安全
- **PCI DSS合规** - 通过Stripe确保支付安全
- **HTTPS强制** - 所有通信加密
- **API密钥管理** - 环境变量安全存储

### 业务安全
- **金额限制** - 防止异常大额充值
- **频率限制** - 防止频繁操作
- **错误处理** - 优雅的失败恢复

## 🚀 部署状态

### 生产环境
- **API服务**: https://balance-api-production-eafc.up.railway.app
- **数据库**: PostgreSQL on Railway
- **监控**: 健康检查端点
- **日志**: 结构化日志输出

### 测试环境
- **Stripe**: 测试模式
- **测试用户**: 已配置测试数据
- **测试卡号**: 4242424242424242

## 📱 用户界面

### 主要页面
1. **支付设置页** - `/stripe-payment.html`
   - 选择Customer Portal或Payment Element
   - 余额状态显示
   - 广告拦截器检测

2. **调试测试页** - `/stripe-elements-test.html`
   - 详细的初始化步骤
   - 实时状态显示
   - 错误诊断信息

3. **成功确认页** - `/payment-success.html`
   - 设置成功确认
   - 手动充值测试
   - 当前余额显示

## 🔄 运维监控

### 自动化任务
- **余额检查**: 每5分钟执行
- **健康检查**: 实时监控
- **错误重试**: 自动重试机制

### 日志记录
- **结构化日志** - JSON格式输出
- **错误跟踪** - 详细的错误堆栈
- **业务日志** - 关键操作记录

## 📞 问题支持

### 常见问题
1. **支付失败** - 检查支付方式有效性
2. **余额不更新** - 确认自动充值已启用
3. **界面加载失败** - 检查广告拦截器设置

### 调试工具
- **测试页面** - 详细的调试信息
- **API测试** - 直接的接口调用
- **日志查看** - Railway控制台日志

---

*本文档提供项目的快速概览，详细信息请参考 [README.md](README.md)*